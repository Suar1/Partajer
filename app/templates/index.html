{% extends "base.html" %}

{% block content %}
<div style="display: flex; gap: 20px;">
    <div style="flex: 1; min-width: 0;">
<h1 id="page-title" data-i18n="title">Investment Share Calculator</h1>

<!-- Share Budget Calculation Panel - Floating at top -->
<div id="calculation-panel" class="calculation-panel calc-panel-floating">
    <div class="calc-panel-header">
        <h3 data-i18n="summary">Share Budget Breakdown</h3>
        <div class="calc-panel-controls">
            <label class="calc-visibility-toggle" title="Show/hide calculation panel">
                <input type="checkbox" id="calc-visibility-checkbox" checked aria-label="Show calculation panel">
                <span class="calc-checkmark"><span class="checkmark-text">âœ“</span></span>
            </label>
            <button type="button" class="calc-toggle-btn" id="calc-toggle-btn" aria-label="Minimize/expand calculation panel" title="Minimize/expand calculation panel">
                <span class="calc-toggle-icon">âˆ’</span>
            </button>
        </div>
    </div>
    <div id="calc-content">
        <div class="calc-item">
            <div class="calc-item-label" data-i18n="basePool">Base Pool:</div>
            <div class="calc-item-value" id="calc-base-pool">0.00%</div>
            <div class="calc-breakdown" id="calc-base-breakdown"></div>
        </div>
        <div class="calc-item">
            <div class="calc-item-label" data-i18n="rolePools">Role Pools:</div>
            <div class="calc-item-value" id="calc-role-pools">0.00%</div>
            <div class="calc-breakdown" id="calc-role-breakdown"></div>
        </div>
        <div class="calc-item" id="calc-property-item" style="display: none;">
            <div class="calc-item-label" data-i18n="propertyPool">Property Pool:</div>
            <div class="calc-item-value" id="calc-property-pool">0.00%</div>
            <div class="calc-breakdown" id="calc-property-breakdown"></div>
        </div>
        <div class="calc-item" id="calc-total-item">
            <div class="calc-item-label" data-i18n="total">Total:</div>
            <div class="calc-item-value calc-total" id="calc-total">0.00%</div>
            <div class="calc-breakdown" id="calc-total-status"></div>
        </div>
        <div style="margin-top: 15px; padding: 10px; background: #f5f5f5; border-radius: 4px; font-size: 0.9em; color: #666;">
            <strong data-i18n="warnOverBudget">Note: Total must equal 100%. Adjust highlighted fields to fix.</strong>
        </div>
    </div>
</div>

<div id="live-distribution" class="role-distribution" style="display: none;">
    <h3 id="live-dist-title" style="margin-top: 0;" data-i18n="currentDist">Current Role Distribution</h3>
    <div class="role-stat">
        <strong id="dev-label" data-i18n="dev">Developers:</strong> <span id="dev-count">0</span> <span class="person-text" data-i18n="person">person(s)</span>
        - <span class="each-gets-text" data-i18n="liveEachGets">Each gets</span> <span id="dev-bonus">0.00</span>% <span class="bonus-text" data-i18n="bonus">bonus</span>
        <span class="help-ico" id="dev-bonus-help" data-i18n-title="ttPerDeveloperTitle" title="Per-developer bonus" aria-label="Per-developer bonus info">
            !<span class="tooltip" data-i18n="ttPerDeveloperBody"><b>Per-developer bonus</b>: Total Developer Bonus Ã· developer count.</span>
        </span>
    </div>
    <div class="role-stat">
        <strong id="const-label" data-i18n="const">Constructors:</strong> <span id="const-count">0</span> <span class="person-text" data-i18n="person">person(s)</span>
        - <span class="each-gets-text" data-i18n="liveEachGets">Each gets</span> <span id="const-bonus">0.00</span>% <span class="bonus-text" data-i18n="bonus">bonus</span>
        <span class="help-ico" id="const-bonus-help" data-i18n-title="ttPerConstructorTitle" title="Per-constructor bonus" aria-label="Per-constructor bonus info">
            !<span class="tooltip" data-i18n="ttPerConstructorBody"><b>Per-constructor bonus</b>: Total Constructor Bonus Ã· constructor count.</span>
        </span>
    </div>
    <div class="role-stat">
        <strong id="inv-label" data-i18n="inv">Investors:</strong> <span id="inv-count">0</span> <span class="person-text" data-i18n="person">person(s)</span>
        - <span class="each-gets-text" data-i18n="liveEachGets">Each gets</span> <span id="inv-bonus">0.00</span>% <span class="bonus-text" data-i18n="bonus">bonus</span>
        <span class="help-ico" id="inv-bonus-help" data-i18n-title="ttPerInvestorTitle" title="Per-investor bonus" aria-label="Per-investor bonus info">
            !<span class="tooltip" data-i18n="ttPerInvestorBody"><b>Per-investor bonus</b>: Total Investor Bonus Ã· investor count.</span>
        </span>
    </div>
    <div class="role-stat" style="margin-top: 10px;">
        <strong id="total-invest-label" data-i18n="cashInvest">Cash Investment (excl. property):</strong> â‚¬<span id="total-investment">0.00</span>
    </div>
</div>

{% include '_banners.html' %}

<form method="POST" id="calc-form">
    {{ form.hidden_tag() }}
    
    <div class="role-section">
        <h2 id="role-bonus-title" class="help-wrap" data-i18n="roleTotals">
            Role Total Bonus Percentages
            <span class="help-ico" id="role-pools-help" data-i18n-title="ttRolePools" title="Role bonuses" aria-label="Role bonuses help">
                !<span class="tooltip" data-i18n="ttRolePools"><b>Role bonuses</b> are a fixed % budget split equally among members of each role. Ensure total share â‰¤ 100% (Base + Role + Property).</span>
            </span>
        </h2>
        <p id="role-bonus-note" class="role-info" data-i18n="roleNote">Note: Each role's bonus percentage will be divided equally among all members with that role.</p>
        
        <div id="budget-bar" style="height:14px;border-radius:7px;overflow:hidden;background:#e5e7eb;margin:8px 0 4px 0;">
            <div id="bar-base" style="height:100%;width:0;background:#93c5fd;float:left"></div>
            <div id="bar-role" style="height:100%;width:0;background:#86efac;float:left"></div>
            <div id="bar-prop" style="height:100%;width:0;background:#fca5a5;float:left"></div>
        </div>
        <div id="budget-bar-legend" style="font-size:12px;color:#555;" data-i18n="budgetBarLegend">Base / Role / Property</div>

        <div class="field-row">
            <label class="help-wrap" data-i18n="devBonusLabel">
                {{ form.developer_bonus.label.text }}
                <span class="help-ico" title="Enter the total % budget reserved for all developers. It will be split equally among developers." aria-label="Developer Bonus help">
                    !<span class="tooltip"><b>Total Developer Bonus</b>: Fixed % pool shared equally by all developers.</span>
                </span>
            </label>
            {{ form.developer_bonus(value=form.developer_bonus.data or 40) }}
            {% if role_counts.developer %}
            <div class="current-split" data-i18n-prefix="currentSplit" data-i18n-per="perDeveloper" data-i18n-plural="developers">
                <span class="current-split-text">Current split: {{ "%.2f"|format(role_bonuses_per_person.developer) }}% per developer ({{ role_counts.developer }} developers)</span>
            </div>
            {% endif %}
        </div>

        <div class="field-row">
            <label class="help-wrap" data-i18n="constBonusLabel">
                {{ form.constructor_bonus.label.text }}
                <span class="help-ico" title="Enter the total % budget reserved for all constructors. It will be split equally among constructors." aria-label="Constructor Bonus help">
                    !<span class="tooltip"><b>Total Constructor Bonus</b>: Fixed % pool shared equally by all constructors.</span>
                </span>
            </label>
            {{ form.constructor_bonus(value=form.constructor_bonus.data or 8) }}
            {% if role_counts.constructor %}
            <div class="current-split" data-i18n-prefix="currentSplit" data-i18n-per="perConstructor" data-i18n-plural="constructors">
                <span class="current-split-text">Current split: {{ "%.2f"|format(role_bonuses_per_person.constructor) }}% per constructor ({{ role_counts.constructor }} constructors)</span>
            </div>
            {% endif %}
        </div>

        <div class="field-row">
            <label class="help-wrap" data-i18n="invBonusLabel">
                {{ form.investor_bonus.label.text }}
                <span class="help-ico" title="Enter the total % budget reserved for all investors. It will be split equally among investors." aria-label="Investor Bonus help">
                    !<span class="tooltip"><b>Total Investor Bonus</b>: Fixed % pool shared equally by all investors.</span>
                </span>
            </label>
            {{ form.investor_bonus(value=form.investor_bonus.data or 40) }}
            {% if role_counts.investor %}
            <div class="current-split" data-i18n-prefix="currentSplit" data-i18n-per="perInvestor" data-i18n-plural="investors">
                <span class="current-split-text">Current split: {{ "%.2f"|format(role_bonuses_per_person.investor) }}% per investor ({{ role_counts.investor }} investors)</span>
            </div>
            {% endif %}
        </div>
    </div>

    <div class="property-section">
        <h3 style="margin-top: 0;" class="help-wrap" data-i18n="propertySection">
            Property Owner Contribution <span class="optional-label" data-i18n="propertyOptional">(Optional)</span>
            <span class="help-ico" id="property-model-help" title="Choose how property contribution is calculated." aria-label="Property model help">
                !<span class="tooltip" id="property-model-tooltip"><b>Property Model</b>: Choose between negotiated fixed share or value-based contribution.</span>
            </span>
        </h3>
            <p id="property-note" class="property-info" data-i18n="propertyNote">Fill this section only if there is a property owner contributing land or property to the project.</p>
        
        <!-- Property Model Toggle -->
        <div class="field-row" style="margin-bottom: 15px; padding: 12px; background: #f8f9fa; border-radius: 4px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600;" data-i18n="propertyModel">Property Model:</label>
            <div id="property-model-options" class="property-model-group">
                <label class="property-model-option">
                    <input type="radio" name="property_model" value="A" id="property_model_A" checked>
                    <span class="property-model-text" data-i18n="modelA">Negotiated % (fixed share) â€” Property Equity/Profit Pool (%) enabled; Property Value is informational.</span>
                </label>
                <label class="property-model-option">
                    <input type="radio" name="property_model" value="B" id="property_model_B">
                    <span class="property-model-text" data-i18n="modelB">Valued contribution (cash-equivalent) â€” Use Property Value in base pool; hide Property Equity/Profit Pool (%).</span>
                </label>
            </div>
            <p id="property-model-b-note" class="model-note" style="display: none; margin-top: 8px; color: #666; font-style: italic;" data-i18n="modelBInfo">
                Property value participates in base pool like cash. No extra property pools.
            </p>
        </div>
        
        <div class="field-row">
            <label class="help-wrap" data-i18n="propValue">
                {{ form.property_value.label.text }}
                <span class="help-ico" title="Estimated market value of contributed land/property." aria-label="Property Value help">
                    !<span class="tooltip"><b>Property Value</b>: Estimated market value of contributed land/property. In Model A, this is informational only. In Model B, this participates in the base pool like cash.</span>
                </span>
            </label>
            {{ form.property_value(value=form.property_value.data or '') }}
        </div>
        <div class="field-row">
            <label data-i18n="propName">{{ form.property_owner.label.text }}</label>
            {{ form.property_owner(value=form.property_owner.data or '') }}
        </div>
        <div class="field-row" id="property-equity-row">
            <label class="help-wrap" data-i18n="propEquityPool">
                {{ form.property_share.label.text }}
                <span class="help-ico" title="Fixed % equity pool allocated to the property owner (Model A only)." aria-label="Property Equity Pool help">
                    !<span class="tooltip"><b>Property Equity Pool</b>: Fixed % equity pool allocated to the property owner. Only applies in Model A (Negotiated %).</span>
                </span>
            </label>
            {{ form.property_share(value=form.property_share.data or 10) }}
            <div class="role-info" data-i18n="ttPropEquityPoolDesc">Equity share from property contribution (Model A only)</div>
        </div>
        <div class="field-row" id="property-profit-row">
            <label class="help-wrap" data-i18n="propProfitPool">
                {{ form.property_profit_share.label.text }}
                <span class="help-ico" title="Additional % profit pool only if Sale Price > Project Cost (Model A only)." aria-label="Property Profit Pool help">
                    !<span class="tooltip"><b>Property Profit Pool</b>: Additional % profit pool only if Sale Price > Project Cost. Only applies in Model A (Negotiated %).</span>
                </span>
            </label>
            {{ form.property_profit_share(value=form.property_profit_share.data or 5) }}
            <div class="role-info" data-i18n="ttPropProfitPoolDesc">Additional share from project profits (Model A only)</div>
        </div>
        
        <!-- Model B specific fields -->
        <div class="field-row" id="property-weight-row" style="display: none;">
            <label class="help-wrap">
                {{ form.property_weight.label.text }}
                <span class="help-ico" title="Scales the land's influence in the base pool. 1.00 = face value, 1.20 = +20% influence, 0.80 = -20%." aria-label="Property Weight help">
                    !<span class="tooltip"><b>Property Weight</b>: Scales the land's influence in the base pool. 1.00 = face value, 1.20 = +20% influence, 0.80 = -20%. Recommended range: 0.5â€“2.0.</span>
                </span>
            </label>
            {{ form.property_weight(value=form.property_weight.data or 1.0, step=0.01, min=0) }}
            <div class="role-info">Scales property value in base pool calculation (Model B only)</div>
        </div>
        <div class="field-row" id="property-profit-min-row" style="display: none;">
            <label class="help-wrap">
                {{ form.property_profit_min_pct.label.text }}
                <span class="help-ico" title="Optional lower bound for the landowner's share of total profit. Leave blank for no minimum." aria-label="Property Profit Min help">
                    !<span class="tooltip"><b>Property Profit Min (%)</b>: Optional lower bound for the landowner's share of total profit. Leave blank for no minimum.</span>
                </span>
            </label>
            {{ form.property_profit_min_pct(value=form.property_profit_min_pct.data or '', step=0.01, min=0, max=100) }}
            <div class="role-info">Minimum profit share for property owner (Model B only, optional)</div>
        </div>
        <div class="field-row" id="property-profit-max-row" style="display: none;">
            <label class="help-wrap">
                {{ form.property_profit_max_pct.label.text }}
                <span class="help-ico" title="Optional upper bound for the landowner's share of total profit. Leave blank for no maximum." aria-label="Property Profit Max help">
                    !<span class="tooltip"><b>Property Profit Max (%)</b>: Optional upper bound for the landowner's share of total profit. Leave blank for no maximum.</span>
                </span>
            </label>
            {{ form.property_profit_max_pct(value=form.property_profit_max_pct.data or '', step=0.01, min=0, max=100) }}
            <div class="role-info">Maximum profit share for property owner (Model B only, optional)</div>
        </div>
    </div>

    <div class="field-row">
        <label class="help-wrap">
            {{ form.project_cost.label.text }}
            <span class="help-ico" title="All costs to complete the project (materials, labor, fees)." aria-label="Project Cost help">
                !<span class="tooltip"><b>Project Cost</b>: All costs to complete the project (materials, labor, fees).</span>
            </span>
        </label>
        {{ form.project_cost(value=form.project_cost.data or '') }}
    </div>

    <div class="field-row">
        <label class="help-wrap" data-i18n="salePrice">
            {{ form.sale_price.label.text }}
            <span class="help-ico" title="Expected sale revenue for the finished project." aria-label="Project Sale Price help">
                !<span class="tooltip"><b>Project Sale Price</b>: Expected sale revenue for the finished project.</span>
            </span>
        </label>
        {{ form.sale_price(value=form.sale_price.data or '') }}
    </div>

    <div id="investors">
        {% if request.form %}
            {% for i in range(1, (request.form|length - 4) // 3 + 1) if request.form.get('name' ~ i) %}
            <div class="investor-box" data-investor-index="{{ i }}">
                <div class="field-row">
                    <label data-i18n="nameLabel">Name:</label>
                    <input type="text" name="name{{ i }}" value="{{ request.form.get('name' ~ i) }}" required>
                </div>
                <div class="field-row">
                    <label data-i18n="roleLabel">Role:</label>
                    <select name="role{{ i }}" required>
                        <option value="" data-i18n="selectRole">Select Role</option>
                        <option value="Developer" {% if request.form.get('role' ~ i) == 'Developer' %}selected{% endif %} data-i18n="roleDeveloper">Developer</option>
                        <option value="Constructor" {% if request.form.get('role' ~ i) == 'Constructor' %}selected{% endif %} data-i18n="roleConstructor">Constructor</option>
                        <option value="Investor" {% if request.form.get('role' ~ i) == 'Investor' %}selected{% endif %} data-i18n="roleInvestor">Investor</option>
                    </select>
                </div>
                <div id="payment-group{{ i }}" class="field-row {% if request.form.get('role' ~ i) == 'Developer' %}hidden{% endif %}">
                    <label data-i18n="paymentLabel">Payment (â‚¬):{% if request.form.get('role' ~ i) == 'Constructor' %} <span style="font-size:0.85em;color:#666;font-weight:normal;" data-i18n="propertyOptional">(Optional)</span>{% endif %}</label>
                    <input type="number" name="paid{{ i }}" value="{{ request.form.get('paid' ~ i, '0') }}" min="0" {% if request.form.get('role' ~ i) == 'Constructor' %}placeholder="Optional"{% endif %}>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="investor-box" data-investor-index="1">
                <div class="field-row">
                    <label data-i18n="nameLabel">Name:</label>
                    <input type="text" name="name1" required>
                </div>
                <div class="field-row">
                    <label data-i18n="roleLabel">Role:</label>
                    <select name="role1" required>
                        <option value="" data-i18n="selectRole">Select Role</option>
                        <option value="Developer" data-i18n="roleDeveloper">Developer</option>
                        <option value="Constructor" data-i18n="roleConstructor">Constructor</option>
                        <option value="Investor" data-i18n="roleInvestor">Investor</option>
                    </select>
                </div>
                <div id="payment-group1" class="field-row">
                    <label data-i18n="paymentLabel">Payment (â‚¬):</label>
                    <input type="number" name="paid1" min="0" placeholder="Optional for Constructor">
                </div>
            </div>
        {% endif %}
    </div>

    <button type="button" class="button" id="add-investor-btn" data-i18n="addInvestor">Add Investor</button>
    <button type="submit" id="calc-btn" class="button" data-i18n="calculate">Calculate</button>
    <button type="button" id="new-calc-btn" class="button" style="background-color: #ff9800;" data-i18n="newCalc">New Calculation</button>
</form>

<!-- Live banners container for API updates -->
<div id="live-banners"></div>

<!-- Results section -->
<div id="results-section"{% if not results or error %} style="display: none;"{% endif %}>
    {% if results and not error %}
    <!-- Main results content -->
    <section id="col-main">
        {% include 'results.html' %}
    </section>
    {% endif %}
</div>
    </div>
    
    <!-- Floating button to show calculation panel when hidden -->
    <button type="button" id="calc-show-btn" class="calc-show-btn" style="display: none;" aria-label="Show calculation panel" title="Show calculation panel">
        <span>ðŸ“Š</span>
    </button>
</div>

{% endblock %}

